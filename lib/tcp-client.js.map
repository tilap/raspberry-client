{"version":3,"sources":["../src/tcp-client.js"],"names":[],"mappings":";;;;;;;;;;;;;;;IAGY;;;;;;;;;;;;;;;;;;;;;;;;;;AAOZ,MAAM,SAAS,+BAAkB,gBAAlB,EAAoC,sBAAS,IAAT,CAA7C;;AAGN,IAAI,YAAJ;AACA,MAAM,SAAS,gBAAW,EAAE,gBAAF,EAAQ,gBAAR,EAAX,CAAT;AACN,MAAM,aAAa,gCAAa,MAAb,CAAb;;AAEN,WAAW,EAAX,CAAc,OAAd,EAAuB,OAAO;AAC1B,WAAO,KAAP,CAAa,GAAb,EAD0B;CAAP,CAAvB;;AAIA,OAAO,EAAP,CAAU,OAAV,EAAmB,OAAO;AACtB,WAAO,KAAP,CAAa,GAAb,EADsB;;AAGtB,QAAI,YAAJ,EAAkB;AACd,sBAAc,YAAd,EADc;KAAlB;;AAIA,eAAW,MAAM,UAAN,EAAkB,IAA7B,EAPsB;CAAP,CAAnB;;AAUA,OAAO,EAAP,CAAU,KAAV,EAAiB,MAAM;AACnB,WAAO,IAAP,CAAY,CAAC,YAAD,CAAZ,EADmB;;AAGnB,QAAI,YAAJ,EAAkB;AACd,sBAAc,YAAd,EADc;KAAlB;;AAIA,eAAW,MAAM,UAAN,EAAkB,IAA7B,EAPmB;CAAN,CAAjB;;;;EAUA,SAAS,QAAT,GAAoB;AAChB,QAAI,OAAO,QAAP,EAAiB;AACjB,eADiB;KAArB;;AAIA,WAAO,IAAP,CAAY,CAAC,cAAD,eAAsB,CAAtB,eAA8B,CAA1C,EALgB;AAMhB,QAAI;AACA,eAAO,OAAP,CAAe,EAAE,gBAAF,EAAQ,gBAAR,EAAf,EADA;KAAJ,CAEE,OAAO,GAAP,EAAY;AACV,eAAO,IAAP,CAAY,mBAAZ,EAAiC,EAAE,SAAS,IAAI,OAAJ,EAA5C,EADU;KAAZ;CARN;;AAaA,OAAO,EAAP,CAAU,SAAV,EAAqB,MAAM;AACvB,UAAM,mBAAmB,iCAAnB,CADiB;AAEvB,WAAO,IAAP,CAAY,CAAC,aAAD,eAAqB,CAArB,eAA6B,CAAzC,EAA4C,EAAE,gBAAF,EAA5C,EAFuB;;AAIvB,mBAAe,YAAY,MAAM,WAAW,KAAX,CAAiB,EAAE,MAAM,MAAN,EAAnB,CAAN,EAA0C,KAAtD,CAAf,CAJuB;;AAMvB,eAAW,KAAX;AACI,cAAM,OAAN;AACA;AACA,qBAAa,sBAAe,IAAf,GAAsB,KAAtB;OACV,iBAJP,EANuB;CAAN,CAArB;;AAcA,WAAW,EAAX,CAAc,MAAd,EAAsB,QAAQ;AAC1B,QAAI,KAAK,IAAL,KAAc,MAAd,EAAsB;AACtB,eAAO,KAAP,CAAa,MAAb,EADsB;AAEtB,eAFsB;KAA1B;;AAKA,WAAO,IAAP,CAAY,MAAZ,EAAoB,IAApB,EAN0B;AAO1B,YAAQ,KAAK,IAAL;AACJ,aAAK,eAAL;AACI,sCAAa,KAAK,MAAL,CAAb,CADJ;AAEI,kBAFJ;AADJ,aAIS,SAAL,CAJJ;AAKI,aAAK,YAAL;AACI,oBAAQ,KAAK,IAAL,CAAR,GADJ;AAEI,kBAFJ;AALJ;AASQ,mBAAO,IAAP,CAAY,CAAC,gBAAD,GAAmB,KAAK,IAAL,EAAU,CAAzC,EADJ;;AARJ,KAP0B;CAAR,CAAtB;;AAqBA","file":"tcp-client.js","sourcesContent":["import { Socket } from 'net';\nimport { ConsoleLogger, LogLevel } from 'nightingale';\nimport { createStream } from 'objectstream';\nimport * as actions from './actions';\nimport { host, port } from './argv';\nimport { updateConfig } from './config';\nimport findNetworkInterface from './networkInterface';\nimport { isOn as isScreenOn } from './screen';\nimport { version } from '../package.json';\n\nconst logger = new ConsoleLogger('app.tcp-client', LogLevel.INFO);\n\n\nlet pingInterval;\nconst socket = new Socket({ host, port });\nconst jsonStream = createStream(socket);\n\njsonStream.on('error', err => {\n    logger.error(err);\n});\n\nsocket.on('error', err => {\n    logger.error(err);\n\n    if (pingInterval) {\n        clearInterval(pingInterval);\n    }\n\n    setTimeout(() => _connect(), 1000);\n});\n\nsocket.on('end', () => {\n    logger.warn(`socket ended`);\n\n    if (pingInterval) {\n        clearInterval(pingInterval);\n    }\n\n    setTimeout(() => _connect(), 1000);\n});\n\nfunction _connect() {\n    if (socket.writable) {\n        return;\n    }\n\n    logger.info(`connecting to ${host}:${port}`);\n    try {\n        socket.connect({ port, host });\n    } catch (err) {\n        logger.warn('could not connect', { message: err.message });\n    }\n}\n\nsocket.on('connect', () => {\n    const networkInterface = findNetworkInterface();\n    logger.info(`connected to ${host}:${port}`, { networkInterface });\n\n    pingInterval = setInterval(() => jsonStream.write({ type: 'ping' }), 10000);\n\n    jsonStream.write({\n        type: 'hello',\n        version,\n        screenState: isScreenOn() ? 'on' : 'off',\n        ...networkInterface,\n    });\n});\n\njsonStream.on('data', data => {\n    if (data.type === 'ping') {\n        logger.debug('ping');\n        return;\n    }\n\n    logger.info('data', data);\n    switch (data.type) {\n        case 'update-config':\n            updateConfig(data.config);\n            break;\n        case 'refresh':\n        case 'selfUpdate':\n            actions[data.type]();\n            break;\n        default:\n            logger.warn(`unknown action: ${data.type}`);\n\n    }\n});\n\n_connect();\n"]}