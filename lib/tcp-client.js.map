{"version":3,"sources":["../src/tcp-client.js"],"names":[],"mappings":"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","file":"tcp-client.js","sourcesContent":["import { Socket } from 'net';\nimport { ConsoleLogger, LogLevel } from 'nightingale';\nimport { createStream } from 'objectstream';\nimport { hostname, port } from './argv';\nimport { getTime as getConfigTime, updateConfig } from './config';\nimport * as display from './display';\nimport findNetworkInterface from './networkInterface';\nimport { currentScreenState } from './screen';\nimport * as screen from './screen';\nimport { selfUpdate } from './update';\nimport { version } from '../package.json';\n\nconst logger = new ConsoleLogger('app.tcp-client', LogLevel.INFO);\n\nlet autorestart = true;\nlet pingInterval;\nconst socket = new Socket({ host: hostname, port });\nconst jsonStream = createStream(socket);\n\njsonStream.on('error', err => {\n    logger.error(err);\n});\n\nsocket.on('error', err => {\n    logger.error(err);\n\n    if (pingInterval) {\n        clearInterval(pingInterval);\n    }\n\n    setTimeout(() => _connect(), 1000);\n});\n\nsocket.on('end', () => {\n    logger[autorestart ? 'warn' : 'info'](`Closed`);\n\n    if (pingInterval) {\n        clearInterval(pingInterval);\n    }\n\n    if (autorestart) {\n        setTimeout(() => _connect(), 1000);\n    }\n});\n\nsocket.setTimeout(120000, () => {\n    socket.destroy(new Error('timeout'));\n});\n\nfunction _connect() {\n    if (socket.writable) {\n        return;\n    }\n\n    logger.info(`connecting to ${hostname}:${port}`);\n    try {\n        socket.connect({ port, host: hostname });\n    } catch (err) {\n        logger.warn('could not connect', { message: err.message });\n    }\n}\n\nsocket.on('connect', () => {\n    const networkInterface = findNetworkInterface();\n    logger.info(`connected to ${hostname}:${port}`, { networkInterface });\n\n    pingInterval = setInterval(() => jsonStream.write({ type: 'ping' }), 30000);\n\n    jsonStream.write({\n        type: 'hello',\n        configTime: getConfigTime(),\n        version,\n        screenState: currentScreenState,\n        ...networkInterface,\n    });\n});\n\njsonStream.on('data', data => {\n    if (data.type === 'ping') {\n        logger.debug('ping');\n        return;\n    }\n\n    logger.info('data', data);\n    switch (data.type) {\n        case 'update-config':\n        case 'change-config':\n            if (updateConfig(data.config)) {\n                display.update();\n            }\n            return;\n\n        case 'self-upgrade':\n        case 'self-update':\n        case 'selfUpdate':\n            return selfUpdate();\n\n        case 'action':\n            switch (data.action) {\n                case 'self-upgrade':\n                case 'self-update':\n                case 'selfUpdate':\n                    return selfUpdate();\n\n                case 'screen-off':\n                    return screen.off();\n                case 'screen-on':\n                    return screen.on();\n\n                case 'refresh':\n                    return display.refresh();\n            }\n            logger.warn(`unknown action: ${data.action}`);\n            return;\n\n        default:\n            logger.warn(`unknown type: ${data.type}`);\n    }\n});\n\n_connect();\n\nexport function sendUpdate(data) {\n    if (jsonStream.writable || socket.writable) {\n        jsonStream.write({\n            type: 'update',\n            ...data,\n        });\n    }\n}\n\n\nexport function close() {\n    autorestart = false;\n    if (socket.writable) {\n        return new Promise((resolve) => {\n            logger.info('Closing...');\n            socket.end(() => {\n                socket.once('end', () => {\n                    resolve();\n                });\n            });\n        });\n    }\n}\n"]}