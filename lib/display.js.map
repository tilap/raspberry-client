{"version":3,"sources":["../src/display.js"],"names":[],"mappings":";;;;;QASgB;QAUA;QAaA;QA8BA;QAMA;;;;;;;;AAhEhB,MAAM,SAAS,+BAAkB,aAAlB,EAAiC,sBAAS,IAAT,CAA1C;;AAEN,IAAI,WAAJ;AACA,IAAI,YAAJ;;;;EAEO,SAAS,OAAT,GAAmB;AACtB,QAAI,YAAJ,EAAkB;AACd,eAAO,GAAP,CAAW,SAAX,EADc;AAEd,cAAM,SAAS,kBAAT,CAFQ;AAGd,eAAO,wBAAU,CAAC,EAAD,GAAK,OAAO,OAAP,EAAe,GAApB,CAAV,EAAoC,CAAC,SAAD,CAApC,CAAP,CAHc;KAAlB,MAIO;AACH,eAAO,IAAP,CAAY,iBAAZ,EADG;KAJP;CADG;;;;EAUA,SAAS,MAAT,GAAkB;AACrB,UAAM,SAAS,kBAAT,CADe;AAErB,QAAI,OAAO,OAAP,KAAmB,OAAnB,EAA4B;AAC5B,eAAO,wBAAU,CAAC,EAAD,GAAK,OAAO,OAAP,EAAe,GAApB,CAAV,EAAoC,CAAC,MAAD,EAAS,OAAO,GAAP,CAA7C,CAAP,CAD4B;KAAhC,MAEO;AACH,eAAO,SAAP,CADG;KAFP;CAFG;;;;EASP,SAAS,UAAT,GAAsB;AAClB,WAAO,wBAAU,cAAV,EAA0B,CAAC,OAAD,CAA1B,CAAP,CADkB;CAAtB;;;;EAIO,SAAS,KAAT,GAAiB;AACpB,QAAI,iBAAiB,SAAjB,EAA4B;AAC5B,eAAO,IAAP,CAAY,yBAAZ,EAD4B;AAE5B,eAF4B;KAAhC;;AAKA,QAAI,YAAJ,EAAkB;AACd,eAAO,IAAP,CAAY,wBAAZ,EADc;AAEd,eAFc;KAAlB;;AAKA,WAAO,IAAP,CAAY,aAAZ,EAXoB;AAYpB,kBAAc,IAAd,CAZoB;;AAcpB,UAAM,SAAS,kBAAT,CAdc;;AAgBpB,QAAI,SAAS,OAAO,OAAP,CAhBO;AAiBpB,WAAO,IAAP,CAAY,OAAZ,EAAqB,EAAE,MAAF,EAAU,KAAK,OAAO,GAAP,EAApC,EAjBoB;AAkBpB,mBAAe,oBAAM,CAAC,EAAD,GAAK,MAAL,EAAY,GAAZ,CAAN,EAAwB,CAAC,OAAD,EAAU,OAAO,GAAP,CAAlC,CAAf,CAlBoB;AAmBpB,iBAAa,MAAb,CAAoB,EAApB,CAAuB,MAAvB,EAA+B,QAAQ,OAAO,KAAP,CAAa,KAAK,QAAL,EAAb,CAAR,CAA/B,CAnBoB;AAoBpB,iBAAa,MAAb,CAAoB,EAApB,CAAuB,MAAvB,EAA+B,QAAQ,OAAO,KAAP,CAAa,KAAK,QAAL,EAAb,CAAR,CAA/B,CApBoB;AAqBpB,iBAAa,EAAb,CAAgB,OAAhB,EAAyB,QAAQ;AAC7B,uBAAe,IAAf,CAD6B;AAE7B,eAAO,KAAP,CAAa,CAAC,+BAAD,GAAkC,IAAlC,EAAuC,CAApD,EAF6B;AAG7B,YAAI,WAAJ,EAAiB;AACb,oBAAQ,QAAR,CAAiB,MAAM,OAAN,CAAjB,CADa;SAAjB;KAHqB,CAAzB,CArBoB;CAAjB;;;;EA8BA,SAAS,OAAT,GAAmB;AACtB,WAAO,IAAP,CAAY,eAAZ,EADsB;AAEtB,WAFsB;AAGtB,WAAO,OAAP,CAHsB;CAAnB;;;;EAMA,SAAS,IAAT,GAAgB;AACnB,kBAAc,KAAd,CADmB;AAEnB,QAAI,YAAJ,EAAkB;AACd,qBAAa,kBAAb,GADc;KAAlB;AAGA,mBAAe,IAAf,CALmB;;AAOnB,QAAI,SAAS,mBAAY,OAAZ,CAPM;AAQnB,WAAO,IAAP,CAAY,MAAZ,EAAoB,EAAE,MAAF,EAApB,EARmB;AASnB,4BAAU,CAAC,EAAD,GAAK,MAAL,EAAY,GAAZ,CAAV,EAA4B,CAAC,MAAD,CAA5B,EATmB;CAAhB","file":"display.js","sourcesContent":["import { ConsoleLogger, LogLevel } from 'nightingale';\nimport { get as getConfig } from './config';\nimport { runScript, spawn } from './scripts';\n\nconst logger = new ConsoleLogger('app.display', LogLevel.INFO);\n\nlet autoRestart;\nlet childProcess;\n\nexport function refresh() {\n    if (childProcess) {\n        logger.log('refresh');\n        const config = getConfig();\n        return runScript(`./${config.display}.sh`, ['refresh']);\n    } else {\n        logger.warn('display stopped');\n    }\n}\n\nexport function update() {\n    const config = getConfig();\n    if (config.display === 'kweb3') {\n        return runScript(`./${config.display}.sh`, ['load', config.url]);\n    } else {\n        return restart();\n    }\n}\n\nfunction runOpenBox() {\n    return runScript('./openbox.sh', ['start']);\n}\n\nexport function start() {\n    if (runOpenBox() !== 'started') {\n        logger.warn('openbox not yet started');\n        return;\n    }\n\n    if (childProcess) {\n        logger.warn('start: already started');\n        return;\n    }\n\n    logger.info('starting...');\n    autoRestart = true;\n\n    const config = getConfig();\n\n    let script = config.display;\n    logger.info('start', { script, url: config.url });\n    childProcess = spawn(`./${script}.sh`, ['start', config.url]);\n    childProcess.stdout.on('data', data => logger.debug(data.toString()));\n    childProcess.stderr.on('data', data => logger.error(data.toString()));\n    childProcess.on('close', code => {\n        childProcess = null;\n        logger.error(`child process exited with code ${code}`);\n        if (autoRestart) {\n            process.nextTick(() => start());\n        }\n    });\n}\n\nexport function restart() {\n    logger.info('restarting...');\n    stop();\n    return start();\n}\n\nexport function stop() {\n    autoRestart = false;\n    if (childProcess) {\n        childProcess.removeAllListeners();\n    }\n    childProcess = null;\n\n    let script = getConfig().display;\n    logger.info('stop', { script });\n    runScript(`./${script}.sh`, ['stop']);\n}\n"]}