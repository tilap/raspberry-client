{"version":3,"sources":["../src/update.js"],"names":[],"mappings":";;;;;QAMgB;;;;;;;;AAFhB,MAAM,SAAS,+BAAkB,YAAlB,EAAgC,sBAAS,IAAT,CAAzC;;;;EAEC,SAAS,UAAT,GAAsB;AACzB,+BAAW,EAAE,UAAU,IAAV,EAAb,EADyB;AAEzB,WAAO,IAAP,CAAY,aAAZ,EAFyB;AAGzB,QAAI;AACA,sCAAU,KAAV,EAAiB,CAAC,OAAD,CAAjB,EAA4B,EAAE,OAAO,SAAP,EAAkB,KAAK,CAAC,GAAE,SAAH,EAAa,IAAb,CAAL,EAAhD,EADA;;yBAEmB,8BAAU,KAAV,EAAiB,CAAC,QAAD,EAAW,aAAX,EAA0B,IAA1B,CAAjB,EAAkD,EAAE,KAAK,CAAC,GAAE,SAAH,EAAa,IAAb,CAAL,EAApD,EAFnB;;cAEQ,2BAFR;;AAGA,YAAI,CAAC,OAAO,QAAP,GAAkB,QAAlB,CAA2B,QAA3B,CAAD,EAAuC;AACvC,mBAAO,IAAP,CAAY,mBAAZ,EADuC;AAEvC,uCAAW,EAAE,UAAU,KAAV,EAAb,EAFuC;AAGvC,mBAAO,KAAP,CAHuC;SAA3C;;AAMA,sCAAU,KAAV,EAAiB,CAAC,MAAD,CAAjB,EAA2B,EAAE,OAAO,SAAP,EAAkB,KAAK,CAAC,GAAE,SAAH,EAAa,IAAb,CAAL,EAA/C,EATA;AAUA,sCAAU,KAAV,EAAiB,CAAC,SAAD,EAAY,cAAZ,CAAjB,EAA8C,EAAE,OAAO,SAAP,EAAkB,KAAK,CAAC,GAAE,SAAH,EAAa,IAAb,CAAL,EAAlE,EAVA;AAWA,sCAAU,KAAV,EAAiB,CAAC,OAAD,EAAU,cAAV,CAAjB,EAA4C,EAAE,OAAO,SAAP,EAAkB,KAAK,CAAC,GAAE,SAAH,EAAa,IAAb,CAAL,EAAhE,EAXA;AAYA,sCAAU,MAAV,EAAkB,CAAC,eAAD,EAAkB,SAAlB,EAA6B,uBAA7B,CAAlB,EAZA;AAaA,eAAO,IAAP,CAbA;KAAJ,CAcE,OAAO,GAAP,EAAY;AACV,eAAO,KAAP,CAAa,IAAI,OAAJ,CAAb,CADU;KAAZ;CAjBC","file":"update.js","sourcesContent":["import { spawnSync } from 'child_process';\nimport { ConsoleLogger, LogLevel } from 'nightingale';\nimport { sendUpdate } from './tcp-client';\n\nconst logger = new ConsoleLogger('app.update', LogLevel.INFO);\n\nexport function selfUpdate() {\n    sendUpdate({ updating: true });\n    logger.info('self update');\n    try {\n        spawnSync('git', ['fetch'], { stdio: 'inherit', cwd: `${__dirname}/../` });\n        const { stdout } = spawnSync('git', ['status', '--porcelain', '-b'], { cwd: `${__dirname}/../` });\n        if (!stdout.toString().includes('behind')) {\n            logger.info('nothing to update');\n            sendUpdate({ updating: false });\n            return false;\n        }\n\n        spawnSync('git', ['pull'], { stdio: 'inherit', cwd: `${__dirname}/../` });\n        spawnSync('npm', ['install', '--production'], { stdio: 'inherit', cwd: `${__dirname}/../` });\n        spawnSync('npm', ['prune', '--production'], { stdio: 'inherit', cwd: `${__dirname}/../` });\n        spawnSync('sudo', ['supervisorctl', 'restart', 'node-raspberry-client']);\n        return true;\n    } catch (err) {\n        logger.error(err.message);\n    }\n}\n"]}