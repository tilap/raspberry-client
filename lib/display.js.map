{"version":3,"sources":["../src/display.js"],"names":[],"mappings":"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","file":"display.js","sourcesContent":["import { ConsoleLogger, LogLevel } from 'nightingale';\nimport { get as getConfig } from './config';\nimport { runScript, spawn } from './scripts';\n\nconst logger = new ConsoleLogger('app.display', LogLevel.INFO);\n\nlet currentDisplay;\nlet autoRestart;\nlet childProcess;\n\nconst displays = {\n    kweb3: { openbox: true },\n    chromium: { openbox: true },\n    livestreamer: { openbox: false },\n}\n\nexport function refresh() {\n    if (childProcess) {\n        logger.log('refresh');\n        const config = getConfig();\n        return runScript(`./${config.display}.sh`, ['refresh']);\n    } else {\n        logger.warn('display stopped');\n    }\n}\n\nexport function update() {\n    logger.info('update');\n    const config = getConfig();\n    if (config.display === 'kweb3' && currentDisplay === config.display) {\n        return runScript(`./${config.display}.sh`, ['load', config.url]);\n    } else {\n        return restart();\n    }\n}\n\nfunction startOpenBox() {\n    logger.info('start openbox');\n    return runScript('./openbox.sh', ['start']);\n}\n\nfunction stopOpenBox() {\n    logger.info('stop openbox');\n    return runScript('./openbox.sh', ['stop']);\n}\n\nfunction startChild() {\n    logger.info('starting child');\n    if (childProcess) {\n        throw new Error('child process already started');\n    }\n\n\n    autoRestart = true;\n\n    const config = getConfig();\n\n    currentDisplay = config.display;\n    logger.info('start', { display: currentDisplay, url: config.url });\n    childProcess = spawn(`./${currentDisplay}.sh`, ['start', config.url]);\n    const thisChildProcess = childProcess;\n    childProcess.stdout.on('data', data => logger.debug(data.toString()));\n    childProcess.stderr.on('data', data => logger.error(data.toString()));\n    childProcess.on('close', code => {\n        const sameChildProcess = thisChildProcess === childProcess;\n        childProcess = null;\n        logger.error(`child process exited with code ${code}`);\n        if (autoRestart && sameChildProcess) {\n            process.nextTick(() => start());\n        }\n    });\n}\n\nexport function openboxStarted() {\n    logger.info('openbox started');\n    const config = getConfig();\n    if (!displays[config.display].openbox) {\n        stopOpenBox();\n    } else {\n        startChild();\n    }\n}\n\nexport function start() {\n    if (childProcess) {\n        logger.warn('start: already started');\n        return;\n    }\n\n    const config = getConfig();\n    logger.info('starting...', { config });\n\n    if (!displays[config.display].openbox) {\n        stopOpenBox();\n        startChild();\n    } else {\n        if (startOpenBox() !== 'started') {\n            logger.warn('openbox not yet started');\n            return;\n        }\n\n        startChild();\n    }\n}\n\nexport function restart() {\n    logger.info('restarting...');\n    stop();\n    return start();\n}\n\nexport function stop() {\n    autoRestart = false;\n    if (childProcess) {\n        childProcess.removeAllListeners();\n    }\n    childProcess = null;\n\n    logger.info('stop', { display: currentDisplay });\n    runScript(`./display.sh`, ['stop']);\n    stopOpenBox();\n}\n"]}